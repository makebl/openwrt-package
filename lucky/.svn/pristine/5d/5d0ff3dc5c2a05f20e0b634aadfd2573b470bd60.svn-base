#!/bin/sh /etc/rc.common
#
# Copyright (C) 2021-2022  sirpdboy  <herboy2008@gmail.com> https://github.com/sirpdboy/luci-app-lucky 
#
# This file is part of lucky .
# 
# This is free software, licensed under the Apache License, Version 2.0 .
#


USE_PROCD=1

START=99
STOP=10

CONF="lucky"
PROG=/usr/bin/lucky
CONFDIR=/etc/lucky
LUCKYCONF=/etc/lucky/lucky.conf
UCICONF=/etc/config/lucky

start_service() {
		stop_service
	if [ -s ${UCICONF} ];then  #存在uci配置文件，从uci配置读取端口
		config_load "$CONF"

		local enabled
		config_get_bool enabled "$CONF" "enabled" "0"
		[ "$enabled" -eq "1" ] || return 1

		local logger port

		config_get_bool logger "$CONF" "logger" "1"
		config_get port "$CONF" "port" "16601"

		[ -s ${LUCKYCONF} ] || {
			[ -d "$CONFDIR" ] || mkdir -p "$CONFDIR" >/dev/null 2>&1
			# lucky自动生成配置文件，不需要提供默认配置
			# [ -s ${CONFDIR}/lucky-default.conf ]  && cp -r $CONFDIR/lucky-default.conf $LUCKYCONF || return 1
		}

		#sed -i "s/16601/$port/g" "$CONF" 端口可能会被用户修改，这个用不上

		logger -t lucky -p warn "lucky is start."
		echo "lucky is start."

		procd_open_instance
		procd_set_param command "$PROG"
		procd_append_param command -c "$LUCKYCONF" -p $port
		[ "x$logger" == x1 ] && procd_set_param stderr 1
		procd_set_param respawn
		procd_close_instance
	else #不存在UCI配置文件将自动启动，除非特别指定端口参数此时登陆后台是默认端口16601参数
		[ -s ${LUCKYCONF} ] || {
			[ -d "$CONFDIR" ] || mkdir -p "$CONFDIR" >/dev/null 2>&1
			# lucky自动生成配置文件，不需要提供默认配置
			# [ -s ${CONFDIR}/lucky-default.conf ]  && cp -r $CONFDIR/lucky-default.conf $LUCKYCONF || return 1
		}

		logger -t lucky -p warn "lucky is start."
		echo "lucky is start."

		procd_open_instance
		procd_set_param command "$PROG"
		procd_append_param command -c "$LUCKYCONF"
		[ "x$logger" == x1 ] && procd_set_param stderr 1
		procd_set_param respawn
		procd_close_instance
	fi
}

stop_service() {
	killall -9 "$PROG" >/dev/null 2>&1
	logger -t lucky -p warn "lucky is stop."
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$CONF"
}
